# This starter workflow is for a CMake project running on multiple platforms. There is a different starter workflow if you just want a single platform.
# See: https://github.com/actions/starter-workflows/blob/main/ci/cmake-single-platform.yml
name: CMake on multiple platforms

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        build_type: [Release]

    steps:
      - uses: actions/checkout@v4

      # ------------------------
      # Linux dependencies
      # ------------------------
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
          sudo apt-get update
          sudo apt-get install -y \
            g++-13 \
            gcc-13 \
            cmake \
            make \
            git \
            python3 \
            python3-dev \
            libssl-dev \
            libyaml-cpp-dev \
            pybind11-dev
          # Set GCC 13 / G++ 13 as default
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100

      # ------------------------
      # Windows dependencies (vcpkg)
      # ------------------------
      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgJsonGlob: '**/vcpkg.json'

      # ------------------------
      # Configure CMake
      # ------------------------
      - name: Configure CMake
        run: >
          cmake -S . -B build
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          -DCMAKE_CXX_STANDARD=23
          -DCMAKE_CXX_STANDARD_REQUIRED=ON
          ${{ runner.os == 'Windows' && format('-DCMAKE_TOOLCHAIN_FILE={0}/scripts/buildsystems/vcpkg.cmake', env.VCPKG_ROOT) || '' }}

      # ------------------------
      # Build
      # ------------------------
      - name: Build
        run: >
          cmake --build build
          ${{ runner.os == 'Windows' && '--config Release' || '' }}
